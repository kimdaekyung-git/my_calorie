# TRD (기술 요구사항 정의서) - 헬스메이트

> 개발자/AI 코딩 파트너가 참조하는 기술 문서입니다.
> 기술 표현을 사용하되, "왜 이 선택인지"를 함께 설명합니다.

---

## MVP 캡슐

| # | 항목 | 내용 |
|---|------|------|
| 1 | 목표 | 귀찮은 입력 과정을 간소화하여 식단을 꾸준히 기록할 수 있게 하기 |
| 2 | 페르소나 | 다이어트 중인 사람 |
| 3 | 핵심 기능 | FEAT-1: 간편 식단 기록 |
| 4 | 성공 지표 (노스스타) | 매일 3끼 기록 달성률 |
| 5 | 입력 지표 | 일일 기록 횟수, 주간 연속 기록 일수 |
| 6 | 비기능 요구 | 식단 입력 3초 이내 완료 |
| 7 | Out-of-scope | 운동 기록, 소셜, 다크 모드, 회원가입/로그인 |
| 8 | Top 리스크 | 입력 귀찮아서 3일 만에 포기 |
| 9 | 완화/실험 | 음식 검색 자동완성 + 최근 기록 재사용 |
| 10 | 다음 단계 | 식단 기록 화면 프로토타입 구현 |

---

## 1. 시스템 아키텍처

### 1.1 고수준 아키텍처

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│   PWA Client    │────▶│   FastAPI        │────▶│   음식 DB API   │
│ (React + Vite)  │     │   (Proxy/Cache)  │     │   (외부 서비스)  │
│                 │     │                  │     │                 │
│  ┌───────────┐  │     └─────────────────┘     └─────────────────┘
│  │ IndexedDB │  │
│  │ (로컬 저장)│  │
│  └───────────┘  │
└─────────────────┘
```

### 1.2 컴포넌트 설명

| 컴포넌트 | 역할 | 왜 이 선택? |
|----------|------|-------------|
| PWA Client | UI, 식단 기록/조회, 로컬 데이터 관리 | 모바일 중심 + 앱스토어 배포 불필요, 오프라인 지원 |
| FastAPI | 음식 DB API 프록시, 캐싱 | 외부 API 호출 중계, CORS 해결, 응답 캐싱 |
| IndexedDB | 식단 기록 영구 저장 | 로컬 저장 요구사항, 브라우저 내장 DB, PWA 호환 |
| 음식 DB API | 음식/칼로리 데이터 제공 | 직접 DB 구축 대신 외부 API 활용 |

---

## 2. 권장 기술 스택

### 2.1 프론트엔드

| 항목 | 선택 | 이유 | 벤더 락인 리스크 |
|------|------|------|-----------------|
| 프레임워크 | React 18 + Vite | 빠른 개발, 넓은 생태계, PWA 지원 | 낮음 |
| 언어 | TypeScript | 타입 안전성, 자동완성, 버그 방지 | - |
| 스타일링 | TailwindCSS | 빠른 UI 개발, 유틸리티 퍼스트, 반응형 쉬움 | 낮음 |
| 상태관리 | Zustand | 간단한 API, 보일러플레이트 최소 | 낮음 |
| 로컬 DB | Dexie.js | IndexedDB 래퍼, 간편한 API, TypeScript 지원 | 낮음 |
| HTTP 클라이언트 | Axios | 인터셉터, 에러 처리 편리 | 낮음 |
| PWA | vite-plugin-pwa | Vite 네이티브 통합, 서비스 워커 자동 생성 | 낮음 |

### 2.2 백엔드

| 항목 | 선택 | 이유 | 벤더 락인 리스크 |
|------|------|------|-----------------|
| 프레임워크 | FastAPI | 빠른 개발, 자동 API 문서, 비동기 지원 | 낮음 |
| 언어 | Python 3.11+ | 초보자 친화적, 풍부한 라이브러리 | - |
| 캐싱 | 인메모리 (dict/TTL) | MVP에서는 간단한 캐싱으로 충분 | 낮음 |
| 검증 | Pydantic v2 | FastAPI 네이티브 통합, 자동 검증 | 낮음 |

### 2.3 데이터베이스

| 항목 | 선택 | 이유 |
|------|------|------|
| 메인 DB | IndexedDB (브라우저 내장) | 로컬 저장 요구사항, 서버 DB 불필요 |
| 래퍼 | Dexie.js | IndexedDB의 복잡한 API를 간단하게 |

### 2.4 인프라

| 항목 | 선택 | 이유 |
|------|------|------|
| 컨테이너 | Docker + Docker Compose | 로컬 개발 일관성, BE/FE 동시 실행 |
| FE 호스팅 | Vercel (또는 Netlify) | 무료, 빠른 배포, PWA 지원 |
| BE 호스팅 | Railway (또는 Render) | 무료 티어, FastAPI 지원 |

---

## 3. 비기능 요구사항

### 3.1 성능

| 항목 | 요구사항 | 측정 방법 |
|------|----------|----------|
| 식단 입력 완료 | < 3초 | 사용자 테스트 |
| 음식 검색 응답 | < 500ms | API 모니터링 |
| 초기 로딩 | < 3s (FCP) | Lighthouse |
| 오프라인 지원 | 기록/조회 가능 | 서비스 워커 테스트 |

### 3.2 보안

| 항목 | 요구사항 |
|------|----------|
| 인증 | 없음 (로컬 전용, 회원가입 불필요) |
| HTTPS | PWA 필수 요구사항 |
| 입력 검증 | 프론트엔드 + 백엔드 양측 검증 |
| API 키 | 환경 변수로 관리 (음식 DB API 키) |

### 3.3 확장성

| 항목 | 현재 | 목표 |
|------|------|------|
| 사용자 | 1명 (개인 사용) | v2: 다중 기기 동기화 |
| 데이터 | 로컬 IndexedDB | v2: 클라우드 백업 |

---

## 4. 외부 API 연동

### 4.1 음식/영양 데이터

| 서비스 | 용도 | 필수/선택 | 비고 |
|--------|------|----------|------|
| 식품안전나라 API (또는 유사 한국 음식 DB) | 음식명으로 칼로리/영양소 검색 | 필수 | 한국 음식 데이터 우선 |
| Open Food Facts API | 글로벌 식품 데이터 보완 | 선택 | 한국 음식 부족 시 보완 |

---

## 5. 접근제어/권한 모델

### 5.1 역할 정의

| 역할 | 설명 | 권한 |
|------|------|------|
| User | 유일한 사용자 (로컬) | 전체 CRUD |

> MVP는 개인 사용 목적이므로 로그인/권한 시스템 불필요.
> 모든 데이터는 로컬 브라우저에 저장됩니다.

---

## 6. 데이터 생명주기

### 6.1 원칙

- **로컬 우선**: 모든 데이터는 브라우저 IndexedDB에 저장
- **내보내기**: JSON 내보내기로 백업 가능 (v2)
- **삭제**: 사용자가 직접 삭제 가능

### 6.2 데이터 흐름

```
사용자 입력 → IndexedDB 저장 → 조회/수정/삭제
음식 검색 → FastAPI 프록시 → 외부 API → 캐싱 → 프론트엔드 표시
```

---

## 7. 테스트 전략 (Contract-First TDD)

### 7.1 개발 방식: Contract-First Development

본 프로젝트는 **계약 우선 개발(Contract-First Development)** 방식을 채택합니다.

```
┌─────────────────────────────────────────────────────────────┐
│                    Contract-First 흐름                       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. 계약 정의 (Phase 0)                                     │
│     ├─ API 계약: contracts/*.contract.ts                   │
│     ├─ BE 스키마: backend/app/schemas/*.py                 │
│     └─ 타입 동기화: TypeScript ↔ Pydantic                  │
│                                                             │
│  2. 테스트 선행 작성 (RED)                                   │
│     ├─ BE 테스트: tests/api/*.py                           │
│     ├─ FE 테스트: src/__tests__/**/*.test.ts               │
│     └─ 모든 테스트가 실패하는 상태 (정상!)                  │
│                                                             │
│  3. Mock 생성 (FE 독립 개발용)                              │
│     └─ MSW 핸들러: src/mocks/handlers/*.ts                 │
│                                                             │
│  4. 병렬 구현 (RED→GREEN)                                   │
│     ├─ BE: 테스트 통과 목표로 구현                          │
│     └─ FE: Mock API로 개발 → 나중에 실제 API 연결          │
│                                                             │
│  5. 통합 검증                                               │
│     └─ Mock 제거 → E2E 테스트                              │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 7.2 테스트 피라미드

| 레벨 | 도구 | 커버리지 목표 | 위치 |
|------|------|-------------|------|
| Unit | pytest / Vitest | >= 80% | tests/unit/, src/__tests__/ |
| Integration | pytest / Vitest + MSW | Critical paths | tests/integration/ |
| E2E | Playwright | Key user flows | e2e/ |

### 7.3 테스트 도구

**백엔드:**
| 도구 | 용도 |
|------|------|
| pytest | 테스트 실행 |
| pytest-asyncio | 비동기 테스트 |
| httpx | API 클라이언트 |
| pytest-cov | 커버리지 측정 |

**프론트엔드:**
| 도구 | 용도 |
|------|------|
| Vitest | 테스트 실행 |
| React Testing Library | 컴포넌트 테스트 |
| MSW (Mock Service Worker) | API 모킹 |
| Playwright | E2E 테스트 |

### 7.4 TDD 사이클

```
RED    → 실패하는 테스트 먼저 작성
GREEN  → 테스트를 통과하는 최소한의 코드 구현
REFACTOR → 테스트 통과 유지하며 코드 개선
```

### 7.5 품질 게이트

**병합 전 필수 통과:**
- [ ] 모든 단위 테스트 통과
- [ ] 커버리지 >= 80%
- [ ] 린트 통과 (ruff / ESLint)
- [ ] 타입 체크 통과 (mypy / tsc)

---

## 8. API 설계 원칙

### 8.1 RESTful 규칙

| 메서드 | 용도 | 예시 |
|--------|------|------|
| GET | 조회 | GET /api/v1/foods?q=김치찌개 |
| POST | 생성 | - |

> MVP에서 백엔드는 음식 검색 프록시 역할만 수행.
> 식단 기록 CRUD는 프론트엔드에서 IndexedDB로 직접 처리.

### 8.2 응답 형식

**성공 응답:**
```json
{
  "data": [
    {
      "name": "김치찌개",
      "calories": 150,
      "serving_size": "1인분 (200g)",
      "nutrients": {
        "carbs": 10,
        "protein": 8,
        "fat": 5
      }
    }
  ],
  "meta": {
    "total": 5,
    "source": "food_safety_korea"
  }
}
```

**에러 응답:**
```json
{
  "error": {
    "code": "EXTERNAL_API_ERROR",
    "message": "음식 데이터를 불러올 수 없습니다."
  }
}
```

---

## 9. 병렬 개발 지원 (Git Worktree)

### 9.1 Worktree 구조

```
~/projects/
├── healthmate/                # 메인 (main 브랜치)
├── healthmate-food-api-be/    # Worktree: feature/food-api-be
├── healthmate-meal-record-fe/ # Worktree: feature/meal-record-fe
└── healthmate-report-fe/      # Worktree: feature/report-fe
```

### 9.2 병합 규칙

| 조건 | 병합 가능 |
|------|----------|
| 단위 테스트 통과 | 필수 |
| 커버리지 >= 80% | 필수 |
| 린트/타입 체크 통과 | 필수 |
| E2E 테스트 통과 | 권장 |

---

## Decision Log

| ID | 항목 | 선택 | 근거 |
|----|------|------|------|
| D-T01 | 프론트엔드 | React + Vite (PWA) | 모바일 중심, 앱스토어 불필요, 오프라인 지원 |
| D-T02 | 백엔드 | FastAPI | 음식 API 프록시용, 빠른 개발, 자동 문서화 |
| D-T03 | 데이터베이스 | IndexedDB (Dexie.js) | 로컬 저장 요구, 서버 DB 불필요 |
| D-T04 | 스타일링 | TailwindCSS | 빠른 UI 개발, 미니멀 디자인에 적합 |
| D-T05 | 상태관리 | Zustand | 간단한 앱에 적합, 보일러플레이트 최소 |
